'use strict';var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_slicedToArray2=require("babel-runtime/helpers/slicedToArray"),_slicedToArray3=_interopRequireDefault(_slicedToArray2),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var _=require("lodash"),Ajv=require("ajv").default,traverse=require("json-schema-traverse"),addFormats=require("ajv-formats").default,_require=require("./loaders/uca"),UCASchemaLoader=_require.UCASchemaLoader,_require2=require("./loaders/cvc"),CVCSchemaLoader=_require2.CVCSchemaLoader,definitions=require("../../claim/definitions"),credentialDefinitions=require("../../creds/definitions"),summaryMap={},SummaryMapper=function(){function a(){(0,_classCallCheck3.default)(this,a)}return(0,_createClass3.default)(a,[{key:"addDefinition",value:function(a){var b=this.getTextLabel(a.identifier);if(b){var c=_.get(summaryMap,b);c?c.labelFor.push(a.identifier):summaryMap[b]={identifier:a.identifier,textLabel:b,credentials:this.getCredentials(a.identifier),labelFor:[a.identifier],changeable:this.isUpdatable(b),claimPath:this.getClaimPath(a.identifier)}}}},{key:"addCredentialDefinition",value:function(a){var b=this.getTextLabel(a.identifier);b&&(summaryMap[b]={identifier:a.identifier,textLabel:b,credentials:[a.identifier],labelFor:[a.identifier],changeable:this.isUpdatable(b),claimPath:null})}},{key:"getTextLabel",value:function(a){var b=_.split(a,"-"),c=(0,_slicedToArray3.default)(b,3),d=c[0],e=c[1],f=c[2],g=_.split(e,":"),h=(0,_slicedToArray3.default)(g,3),i=h[0],j=h[1],k=h[2];if(d&&j)return(j+"."+d+(k?"."+k:"")).toLowerCase()}},{key:"isUpdatable",value:function(a){return!_.includes(["document.placeofbirth.claim","document.dateofbirth.claim"],a)}},{key:"getCredentials",value:function(a){var b=_.split(a,"-"),c=(0,_slicedToArray3.default)(b,3),d=c[0],e=c[1],f=c[2];if("credential"===d)return[a];var g=_.filter(credentialDefinitions,function(b){return _.includes(b.depends,a)});return _.map(g,function(a){return a.identifier})}},{key:"getClaimPath",value:function(b){var c=_.split(b,"-"),d=(0,_slicedToArray3.default)(c,3),e=d[0],f=d[1],g=d[2];return"credential"===e?null:a.getPath(b)}}],[{key:"getBaseIdentifiers",value:function(a){var b=!0,c=/claim-cvc:(.*)\.(.*)-v\d*/.exec(a);return null===c&&(c=_.split(a,":"),b=!1),{identifierComponents:c,isNewIdentifier:b}}},{key:"getPath",value:function(b){var c=a.getBaseIdentifiers(b),d=c.identifierComponents,e=_.camelCase(d[1]);return"type"===e?d[2]:e+"."+d[2]}}]),a}(),SchemaLoader=function(){function a(){(0,_classCallCheck3.default)(this,a),this.loaders=[],this.definitions=definitions,this.credentialDefinitions=credentialDefinitions,this.summaryMap=summaryMap,this.summaryMapper=new SummaryMapper,this.validIdentifiers=[],this.validCredentialIdentifiers=[],this.ajv=new Ajv({logger:console,allErrors:!0,verbose:!0}),addFormats(this.ajv),this.ajv.addKeyword("attestable"),this.ajv.addKeyword("transient"),this.ajv.addKeyword("credentialItem"),this.addLoader(new UCASchemaLoader),this.addLoader(new CVCSchemaLoader)}return(0,_createClass3.default)(a,[{key:"addLoader",value:function(a){this.loaders.push(a)}},{key:"loadSchemaFromUri",value:function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(b){var c;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=b.split("#")[0].match("[^/]+$",b),a.abrupt("return",this.loadSchemaFromTitle(c[0]));case 2:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"addDefinition",value:function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(b){return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!/^credential-/.test(b.title)){a.next=5;break}return a.next=3,this.addCredentialDefinition(b);case 3:a.next=7;break;case 5:return a.next=7,this.addClaimDefinition(b);case 7:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"addCredentialDefinition",value:function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(b){var c,d,e,f,g,h;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:c={identifier:b.title,version:"1",depends:[]},b.transient&&(c.transient=!0),b.properties.claim.required&&(c.required=[]),a.t0=_regenerator2.default.keys(b.properties.claim.properties);case 4:if((a.t1=a.t0()).done){a.next=20;break}d=a.t1.value,e=b.properties.claim.properties[d],a.t2=_regenerator2.default.keys(e.properties);case 8:if((a.t3=a.t2()).done){a.next=18;break}return f=a.t3.value,g=e.properties[f],a.next=13,this.loadSchemaFromUri(g.$ref);case 13:h=a.sent,null!==h&&c.depends.push(h.title),b.properties.claim.required&&b.properties.claim.required.includes(f)&&c.required.push(h.title),a.next=8;break;case 18:a.next=4;break;case 20:this.credentialDefinitions.push(c),this.validCredentialIdentifiers.push(c.identifier),this.summaryMapper.addCredentialDefinition(c);case 23:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"addClaimDefinition",value:function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(b){var c,d;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=b.title,a.next=3,this.findDefinitionType(b);case 3:if(a.t1=a.sent,c={identifier:a.t0,version:"1",type:a.t1},"Array"!==c.type){a.next=10;break}return a.next=8,this.loadSchemaFromUri(b.items.$ref);case 8:d=a.sent,c.items={type:d.title};case 10:["attestable","credentialItem","minimum","maximum"].forEach(function(a){a in b&&(c[a]=b[a])}),b.required&&(c.type.required=b.required),this.definitions.push(c),this.validIdentifiers.push(b.title),this.summaryMapper.addDefinition(c);case 15:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"getPropertyValues",value:function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(b){var c,d,e,f,g,h,i;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:c=[],a.t0=_regenerator2.default.keys(b);case 2:if((a.t1=a.t0()).done){a.next=17;break}if(d=a.t1.value,e=b[d],f=e.type,g=e.items,"array"===f&&(g.$ref?f=g.$ref.replace("http://identity.com/schemas/",""):f=_.capitalize(f)),!e.allOf){a.next=13;break}return a.next=11,this.loadSchemaFromUri(e.allOf[0].$ref);case 11:h=a.sent,f=h.title;case 13:i={name:d,type:f},c.push(i),a.next=2;break;case 17:return a.abrupt("return",{properties:c});case 18:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"findDefinitionType",value:function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(b){var c,d;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if("object"!==b.type){a.next=12;break}if(_.isEmpty(b.properties)){a.next=6;break}return a.next=4,this.getPropertyValues(b.properties);case 4:return c=a.sent,a.abrupt("return",c);case 6:return a.next=8,this.loadSchemaFromUri(b.allOf[0].$ref);case 8:if(d=a.sent,null!=d){a.next=11;break}return a.abrupt("return",null);case 11:return a.abrupt("return",d.title);case 12:if("array"!==b.type){a.next=14;break}return a.abrupt("return","Array");case 14:return a.abrupt("return",_.capitalize(b.type));case 15:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"loadSchemaFromTitle",value:function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(b){var c,d,e,f,g,h=this;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(c=this.findSchemaLoader(b),null!=c){a.next=3;break}return a.abrupt("return",null);case 3:if(d=c.schemaId(b),e=this.ajv.getSchema(d),f=void 0,e){a.next=27;break}return a.next=9,c.loadSchema(b);case 9:if(f=a.sent,null!==f){a.next=12;break}return a.abrupt("return",null);case 12:a.prev=12,this.ajv.addSchema(f),a.next=19;break;case 16:return a.prev=16,a.t0=a["catch"](12),a.abrupt("return",null);case 19:return a.next=21,this.addDefinition(f);case 21:return g=[],traverse(f,{cb:function(a){void 0!==a.$ref&&g.push(h.loadSchemaFromUri(a.$ref))}}),a.next=25,_promise2.default.all(g);case 25:a.next=30;break;case 27:return a.next=29,c.loadSchema(b);case 29:f=a.sent;case 30:return a.abrupt("return",f);case 31:case"end":return a.stop();}},a,this,[[12,16]])}));return function(){return a.apply(this,arguments)}}()},{key:"validate",value:function(a,b){var c=this.ajv.getSchema(a);if("undefined"==typeof c)throw new Error("Invalid schema id: "+a);var d=c(b);if(!d)throw new Error("Invalid value. Errors: "+(0,_stringify2.default)(c.errors,null,2))}},{key:"findSchemaLoader",value:function(a){var b=null;return _.forEach(this.loaders,function(c){c.valid(a)&&(b=c)}),null==b?null:b}},{key:"validateSchema",value:function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(b,c){var d;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=this.findSchemaLoader(b),a.next=3,this.loadSchemaFromTitle(b);case 3:this.validate(d.schemaId(b),c);case 4:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()}]),a}(),schemaLoader=new SchemaLoader;module.exports={schemaLoader:schemaLoader};