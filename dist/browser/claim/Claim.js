'use strict';var _toConsumableArray2=require("babel-runtime/helpers/toConsumableArray"),_toConsumableArray3=_interopRequireDefault(_toConsumableArray2),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_getPrototypeOf=require("babel-runtime/core-js/object/get-prototype-of"),_getPrototypeOf2=_interopRequireDefault(_getPrototypeOf),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),_possibleConstructorReturn2=require("babel-runtime/helpers/possibleConstructorReturn"),_possibleConstructorReturn3=_interopRequireDefault(_possibleConstructorReturn2),_get2=require("babel-runtime/helpers/get"),_get3=_interopRequireDefault(_get2),_inherits2=require("babel-runtime/helpers/inherits"),_inherits3=_interopRequireDefault(_inherits2);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var _=require("lodash"),sjcl=require("sjcl"),_require=require("@identity.com/uca"),UserCollectableAttribute=_require.UserCollectableAttribute,definitions=require("./definitions"),_require2=require("../services"),services=_require2.services,validIdentifiers=_.map(definitions,function(a){return a.identifier}),getDefinition=function(a,b){return b?_.find(definitions,{identifier:a,version:b}):_.find(definitions,{identifier:a})},isArrayAttestableValue=function(a){return-1<a.indexOf("[")&&-1<a.indexOf("]")};function getBaseIdentifiers(a){var b=!0,c=/claim-cvc:(.*)\.(.*)-v\d*/.exec(a);return null===c&&(c=_.split(a,":"),b=!1),{identifierComponents:c,isNewIdentifier:b}}function adaptIdentifierIfNeeded(a,b){var c=getDefinition(a,b),d=c&&c.alias?c.type:a,e=getBaseIdentifiers(d),f=e.isNewIdentifier,g=e.identifierComponents;if(!f&&!getDefinition(d,b)){var h="claim-cvc:"+g[1]+"."+g[2]+"-v1",i=_.find(definitions,{identifier:h});if(i)return h;throw new Error(d+" is not defined")}return a}var Claim=function(a){function b(a,c,d){(0,_classCallCheck3.default)(this,b);var e=adaptIdentifierIfNeeded(a,d),f=(0,_possibleConstructorReturn3.default)(this,(b.__proto__||(0,_getPrototypeOf2.default)(b)).call(this,e,c,d,definitions));return f.initialize(e,c,d),f}return(0,_inherits3.default)(b,a),(0,_createClass3.default)(b,[{key:"initialize",value:function(a,c,d){if((0,_get3.default)(b.prototype.__proto__||(0,_getPrototypeOf2.default)(b.prototype),"initialize",this).call(this,a,c,d),!this.salt){var e=services.container.SecureRandom;this.salt=sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(e.wordWith(64)))}}},{key:"initializeValuesWithArrayItems",value:function(a,c,d){var e=getDefinition(this.identifier,this.version),f=[];if(!_.isArray(c))throw new Error("Value for "+a+"-"+d+" should be an array");_.forEach(c,function(a){var c=new b(_.get(e,"items.type"),a);f.push(c)}),this.value=f}},{key:"initializeAttestableValue",value:function(){var a=this,c=this.value,d=getDefinition(this.identifier,this.version),e=b.parseAttestableValue(c);if(1===e.length){this.timestamp=null,this.salt=e[0].salt;var f=e[0].value;this.value="Array"===d.type?_.map(f,function(a){return new b(d.items.type,{attestableValue:a})}):this.value=_.includes(["null","undefined"],f)?null:f}else{for(var g={},h=function(c){var f=e[c].propertyName,h=void 0,i=void 0,j=UserCollectableAttribute.resolveType(d,definitions),k=j.properties.find(function(a){return a.name===f});if(k)h=k.type,i=f;else{var l=f.split("."),m=l[l.length-2],n=m.substring(0,1).toUpperCase()+m.substring(1);i=l[l.length-1],h="cvc:"+n+":"+i}var o=definitions.find(function(a){return a.identifier===h});o||(h=a.findDefinitionByAttestableValue(i,d)),g[f]=new b(h,{attestableValue:e[c].stringValue})},j=0;j<e.length;j+=1)h(j);this.value=g}}},{key:"getValidIdentifiers",value:function(){return validIdentifiers}},{key:"findDefinitionByAttestableValue",value:function(a,b){var c=UserCollectableAttribute.resolveType(b,definitions),d=!0,e=!1,f=void 0;try{for(var g,h=(0,_getIterator3.default)(c.properties);!(d=(g=h.next()).done);d=!0){var i=g.value,j=_.find(definitions,{identifier:i.type});if(j.type=UserCollectableAttribute.resolveType(j,definitions),!j.type.properties&&i.name===a)return i.type;if(j.type.properties)return this.findDefinitionByAttestableValue(a,j)}}catch(a){e=!0,f=a}finally{try{!d&&h.return&&h.return()}finally{if(e)throw f}}return null}},{key:"getAttestableValue",value:function(a){var b=this,c=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],d=getBaseIdentifiers(this.identifier),e=d.identifierComponents,f=e[2];if(c&&(f=null),a&&(f=a+"."+f),0<=["String","Number","Boolean"].indexOf(this.type))return"urn:"+f+":"+this.salt+":"+this.value+"|";if("Array"===this.type){var g=_.reduce(this.value,function(a,b){return""+a+b.getAttestableValue(null,!0)+","},"");return"urn:"+f+":"+this.salt+":["+g+"]"}return _.reduce(_.sortBy(_.keys(this.value)),function(a,c){return""+a+b.value[c].getAttestableValue(f)},"")}},{key:"getGlobalIdentifier",value:function(){return"claim-"+this.identifier+"-"+this.version}},{key:"getClaimRootPropertyName",value:function(){var a=getBaseIdentifiers(this.identifier),b=a.identifierComponents;return"type"===b[1].toLowerCase()?"":_.camelCase(b[1])}},{key:"getClaimPropertyName",value:function(){var a=getBaseIdentifiers(this.identifier),b=a.identifierComponents;return b[2]}},{key:"getClaimPath",value:function(){return b.getPath(this.identifier)}},{key:"getAttestableValues",value:function(a){var b=this,c=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],d=function(a,b){var c=a?_.split(a,"."):[],d=b?_.split(b,"."):[];d=_.last(c)===_.first(d)?d.splice(1):d;var e=_.join([].concat((0,_toConsumableArray3.default)(c),(0,_toConsumableArray3.default)(d)),".");return e},e=[],f=_.find(definitions,{identifier:this.identifier,version:this.version});if(f.credentialItem||f.attestable){var g=d(a,c?null:this.getClaimPath());e.push({identifier:this.identifier,value:this.getAttestableValue(null,c),claimPath:g}),"Object"===this.type?_.forEach(_.keys(this.value),function(a){var c=b.value[a].getAttestableValues(g);e=_.concat(e,c)}):"Array"===this.type&&_.forEach(this.value,function(a,b){var c;(c=e).push.apply(c,(0,_toConsumableArray3.default)(a.getAttestableValues(g+"."+b,!0)))})}return e}}],[{key:"resolveType",value:function(a){return UserCollectableAttribute.resolveType(a,definitions)}},{key:"parseAttestableArrayValue",value:function(a){var c=a.attestableValue.split(":"),d=c[1],e=c[2],f=a.attestableValue.substring(a.attestableValue.indexOf("[")+1,a.attestableValue.indexOf("]")-1).split(","),g=_.map(f,function(a){return b.parseAttestableValue({attestableValue:a})});return{propertyName:d,salt:e,value:g}}},{key:"parseAttestableValue",value:function(a){var c=[];if(_.isArray(a.attestableValue))return a.attestableValue;if(isArrayAttestableValue(a.attestableValue)){var d=b.parseAttestableArrayValue(a);return[d]}var e=_.split(a.attestableValue,"|");if(_.each(e,function(a){var b=/^urn:(\w+(?:\.\w+)*):(\w+):(.+)/.exec(a);if(b&&4===b.length){var d={propertyName:b[1],salt:b[2],value:b[3],stringValue:a};c.push(d)}}),e.length!==c.length&&e.length!==c.length+1)throw new Error("Invalid attestableValue");return c}},{key:"getPath",value:function(a){var b=getBaseIdentifiers(a),c=b.identifierComponents,d=_.camelCase(c[1]);return"type"===d?c[2]:d+"."+c[2]}},{key:"getTypeName",value:function(a){if(_.isString(a.type)){if(_.includes(validIdentifiers,a.type)){var b=_.find(definitions,{identifier:a.type});return this.getTypeName(b)}return a.type}return"Object"}},{key:"getAllProperties",value:function(a,b){var c=this,d=_.find(definitions,{identifier:a}),e=[],f=UserCollectableAttribute.resolveType(d,definitions),g=_.isString(f)?_.find(definitions,{identifier:f}):d;if(g&&"Object"===this.getTypeName(g)){var h;if(g.type.properties)h=g.type.properties;else{var i=_.find(definitions,{identifier:g.type});h=UserCollectableAttribute.resolveType(i,definitions).properties}var j=void 0,k=getBaseIdentifiers(a),l=k.identifierComponents;j=b?_.includes(b,_.lowerCase(l[1]))?""+b:b+"."+_.lowerCase(l[1])+"."+l[2]:_.lowerCase(l[1])+"."+l[2],_.includes(["String","Number","Boolean"],""+h.type)?e.push(j+"."+h.name):_.forEach(h,function(a){var b=getBaseIdentifiers(a.type),d=b.isNewIdentifier,f=d?j+"."+a.name:j,g=c.getAllProperties(a.type,f);_.forEach(g,function(a){return e.push(a)})})}else if(b){var m=getBaseIdentifiers(d.identifier),n=m.identifierComponents,o=void 0;o=0<=b.indexOf(n[2])?""+b:b+"."+n[2],e.push(o)}else{var p=getBaseIdentifiers(a),q=p.identifierComponents,r=_.lowerCase(q[1])+"."+q[2];e.push(r)}return e}}]),b}(UserCollectableAttribute);function convertIdentifierToClassName(a){var b=getBaseIdentifiers(a),c=b.identifierComponents,d=c[1],e=_.upperFirst(_.camelCase(c[2]));return""+d+e}function mixinIdentifiers(a){return _.forEach(_.filter(definitions,function(a){return a.credentialItem}),function(a){var b=convertIdentifierToClassName(a.identifier),c={},d=a.identifier;c[b]=function(a,b){return new Claim(d,a,b)},_.mixin(Claim,c)}),a}module.exports={Claim:mixinIdentifiers(Claim),definitions:definitions,getBaseIdentifiers:getBaseIdentifiers};